{"filter":false,"title":"procesar.py","tooltip":"/procesar/procesar.py","undoManager":{"mark":1,"position":1,"stack":[[{"start":{"row":0,"column":0},"end":{"row":74,"column":0},"action":"insert","lines":["import boto3","import csv","import datetime","from bs4 import BeautifulSoup","","s3_client = boto3.client(\"s3\")","BUCKET_DESTINO = \"eltiempop\"  # cambia si usas otro bucket","","def app(event, context):","    bucket_origen = event[\"Records\"][0][\"s3\"][\"bucket\"][\"name\"]","    archivo_html = event[\"Records\"][0][\"s3\"][\"object\"][\"key\"]","    print(f\"Procesando archivo: {archivo_html} desde {bucket_origen}\")","","    # Descargar archivo HTML desde S3","    response = s3_client.get_object(Bucket=bucket_origen, Key=archivo_html)","    contenido_html = response[\"Body\"].read().decode(\"utf-8\")","    soup = BeautifulSoup(contenido_html, \"html.parser\")","","    # Detectar nombre del periódico por el nombre del archivo","    if \"espectador\" in archivo_html.lower():","        periodico = \"elespectador\"","    else:","        periodico = \"eltiempo\"","","    noticias = []","","    # Extraer noticias según el periódico","    if periodico == \"eltiempo\":","        for noticia in soup.select(\"article\"):","            categoria = noticia.find(\"a\", class_=\"category\")","            titulo = noticia.find(\"h3\")","            link = noticia.find(\"a\", href=True)","","            if categoria and titulo and link:","                noticias.append({","                    \"Categoria\": categoria.text.strip(),","                    \"Titular\": titulo.text.strip(),","                    \"Link\": \"https://www.eltiempo.com\" + link[\"href\"]","                })","    elif periodico == \"elespectador\":","        for noticia in soup.select(\"section article\"):","            categoria = noticia.find(\"span\", class_=\"section\")","            titulo = noticia.find(\"h2\") or noticia.find(\"h3\")","            link = noticia.find(\"a\", href=True)","","            if categoria and titulo and link:","                noticias.append({","                    \"Categoria\": categoria.text.strip(),","                    \"Titular\": titulo.text.strip(),","                    \"Link\": link[\"href\"] if link[\"href\"].startswith(\"http\") else \"https://www.elespectador.com\" + link[\"href\"]","                })","","    # Fecha para la ruta","    hoy = datetime.datetime.now()","    year = hoy.strftime(\"%Y\")","    month = hoy.strftime(\"%m\")","    day = hoy.strftime(\"%d\")","","    nombre_csv = archivo_html.replace(\".html\", \".csv\").split(\"/\")[-1]","    ruta_local = f\"/tmp/{nombre_csv}\"","    ruta_s3 = f\"headlines/final/periodico={periodico}/year={year}/month={month}/day={day}/{nombre_csv}\"","","    # Crear CSV","    with open(ruta_local, \"w\", newline=\"\", encoding=\"utf-8-sig\") as csvfile:","        campos = ['Categoria', 'Titular', 'Link']","        writer = csv.DictWriter(csvfile, fieldnames=campos)","        writer.writeheader()","        writer.writerows(noticias)","","    # Subir CSV a S3","    s3_client.upload_file(ruta_local, BUCKET_DESTINO, ruta_s3)","    print(f\"CSV subido a s3://{BUCKET_DESTINO}/{ruta_s3}\")","","    return {}",""],"id":1}],[{"start":{"row":6,"column":18},"end":{"row":6,"column":27},"action":"remove","lines":["eltiempop"],"id":2},{"start":{"row":6,"column":18},"end":{"row":6,"column":19},"action":"insert","lines":["r"]},{"start":{"row":6,"column":19},"end":{"row":6,"column":20},"action":"insert","lines":["e"]},{"start":{"row":6,"column":20},"end":{"row":6,"column":21},"action":"insert","lines":["c"]},{"start":{"row":6,"column":21},"end":{"row":6,"column":22},"action":"insert","lines":["i"]},{"start":{"row":6,"column":22},"end":{"row":6,"column":23},"action":"insert","lines":["b"]},{"start":{"row":6,"column":23},"end":{"row":6,"column":24},"action":"insert","lines":["i"]},{"start":{"row":6,"column":24},"end":{"row":6,"column":25},"action":"insert","lines":["e"]},{"start":{"row":6,"column":25},"end":{"row":6,"column":26},"action":"insert","lines":["n"]},{"start":{"row":6,"column":26},"end":{"row":6,"column":27},"action":"insert","lines":["d"]},{"start":{"row":6,"column":27},"end":{"row":6,"column":28},"action":"insert","lines":["o"]}]]},"ace":{"folds":[],"scrolltop":632,"scrollleft":0,"selection":{"start":{"row":52,"column":24},"end":{"row":52,"column":24},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":44,"state":"start","mode":"ace/mode/python"}},"timestamp":1748481716108,"hash":"4f3e1a5734c4ca918aa6c17650190f773b752c25"}